services:
  # Main Application - WhatsApp Integration Service
  - type: web
    name: whatsapp-integration
    env: node
    plan: free
    buildCommand: npm ci
    startCommand: npm run webhook
    envVars:
      - key: NODE_ENV
        value: production
      - key: WEBHOOK_PORT
        value: 3000
      # Evolution API Configuration
      - key: SERVER_URL
        sync: false  # Set to Evolution API URL after deployment
      - key: EVOLUTION_API_URL
        sync: false  # Set to Evolution API URL after deployment
      - key: AUTHENTICATION_API_KEY
        sync: false  # Set in Render dashboard
      - key: INSTANCE_NAME
        value: default
      # WhatsApp Configuration
      - key: DEFAULT_PHONE_NUMBER
        sync: false  # Set in Render dashboard
      # OCP Configuration
      - key: OCP_WS_URL
        sync: false  # Set in Render dashboard
      - key: OCP_API_KEY
        sync: false  # Set in Render dashboard
      # Optional Services
      - key: OPENAI_API_KEY
        sync: false  # Optional - for audio transcription
      - key: LOGGING_ENDPOINT_URL
        sync: false  # Set in Render dashboard
      - key: REDIS_URL
        fromService:
          name: whatsapp-redis
          type: redis
          property: connectionString

  # Evolution API - WhatsApp API Service
  - type: web
    name: evolution-api
    env: node
    plan: free
    rootDir: evolution-api
    buildCommand: npm cache clean --force && npm ci --ignore-scripts && npm run db:generate && npm run build && npm run db:deploy
    startCommand: npm run start:prod
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        sync: false  # Set from PostgreSQL service
      - key: DATABASE_CONNECTION_URI
        fromEnvVar: DATABASE_URL  # Prisma schema expects DATABASE_CONNECTION_URI
      - key: REDIS_URL
        fromService:
          name: whatsapp-redis
          type: redis
          property: connectionString
      - key: AUTHENTICATION_API_KEY
        sync: false  # Set in Render dashboard
      - key: SERVER_URL
        sync: false  # Will be auto-set to service URL

  # Redis
  - type: redis
    name: whatsapp-redis
    plan: free
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []  # Empty array allows all IPs (for internal Render services)